apiVersion: apps/v1
kind: Deployment
metadata:
  name: nkd-linkedpipes-etl-deployment
  namespace: nkd
  labels:
    app.kubernetes.io/name: linkedpipes-etl
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: linkedpipes-etl
  replicas: 1
  template:
    metadata:
      labels:
        app.kubernetes.io/name: linkedpipes-etl
    spec:
      volumes:
        - name: linkedpipes-etl-volume
          persistentVolumeClaim:
            claimName: nkd-linkedpipes-etl-pvc
        - name: public-volume
          persistentVolumeClaim:
            claimName: nkd-public-pvc
        - name: adapter-volume
          persistentVolumeClaim:
            claimName: nkd-adapter-pvc
        - name: linkedpipes-etl-configuration
          configMap:
            name: nkd-linkedpipes-elt
            items:
              - key: lp-etl-configuration.ttl
                path: lp-etl-configuration.ttl
      securityContext:
          fsGroup: 5987
          fsGroupChangePolicy: "OnRootMismatch"
      containers:
        - name: nkd-linkedpipes-etl-storage
          image: ghcr.io/linkedpipes/etl-storage:2023-04-03
          imagePullPolicy: Always
          env:
            - name: LP_ETL_DOMAIN
              value: "http://localhost:8080"
            - name: LP_ETL_MONITOR_URL
              value: "http://localhost:8081"
          ports:
            - containerPort: 8083
          volumeMounts:
            - mountPath: "/data/lp-etl/"
              name: linkedpipes-etl-volume
          securityContext:
            runAsUser: 5987
            runAsGroup: 5987
            runAsNonRoot: true
        - name: nkd-linkedpipes-etl-frontend
          image: ghcr.io/linkedpipes/etl-frontend:2024-01-08
          imagePullPolicy: Always
          env:
            - name: LP_ETL_DOMAIN
              value: "http://localhost:8080"
            - name: LP_ETL_MONITOR_URL
              value: "http://localhost:8081"
            - name: LP_ETL_STORAGE_URL
              value: "http://localhost:8083"
            - name: LP_ETL_FRONTEND_LOG
              value: ""
          ports:
            - containerPort: 80
          securityContext:
            runAsUser: 5987
            runAsGroup: 5987
            runAsNonRoot: true
        - name: nkd-linkedpipes-etl-executor
          image: ghcr.io/linkedpipes/etl-executor:2023-04-03
          imagePullPolicy: Always
          # We need to keep limits synch with -Xmx command.
          command: ["java", "-DconfigFileLocation=/opt/lp-etl/configuration/configuration.properties", "-Xmx12g", "-jar" ,"./executor/executor.jar"]
          resources:
            requests:
              memory: "8Gi"
            limits:
              memory: "12Gi"
          env:
            - name: LP_ETL_DOMAIN
              value: "http://localhost:8080"
            - name: LP_ETL_STORAGE_URL
              value: "http://localhost:8083"
            - name: LP_ETL_INSTANCE_URL
              value: "http://localhost:8080"
            # Virtuoso National Open Data Catalog
            - name: LP_ETL_NKOD_VIRTUOSO_NDC_URL
              value: nkd-virtuoso-ndc
            - name: LP_ETL_NKOD_VIRTUOSO_NDC_USER
              value: dba
            - name: LP_ETL_NKOD_VIRTUOSO_NDC_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: nkd-virtuoso-ndc-secret
                  key: virtuoso_dba_password
            - name: LP_ETL_NKOD_VIRTUOSO_NDC_SSH_USER
              value: sshuser
            - name: LP_ETL_NKOD_VIRTUOSO_NDC_SSH_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: nkd-virtuoso-ndc-secret
                  key: virtuoso_ssh_password
            # Virtuoso Vocabulary
            - name: LP_ETL_NKOD_VIRTUOSO_VOCABULARY_URL
              value: nkd-virtuoso-vocabulary
            - name: LP_ETL_NKOD_VIRTUOSO_VOCABULARY_USER
              value: dba
            - name: LP_ETL_NKOD_VIRTUOSO_VOCABULARY_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: nkd-virtuoso-vocabulary-secret
                  key: virtuoso_dba_password
            - name: LP_ETL_NKOD_VIRTUOSO_VOCABULARY_SSH_USER
              value: sshuser
            - name: LP_ETL_NKOD_VIRTUOSO_VOCABULARY_SSH_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: nkd-virtuoso-vocabulary-secret
                  key: virtuoso_ssh_password
            # CouchDB
            - name: LP_ETL_NKOD_COUCHDB_URL
              value: http://nkd-couchdb:5984/
            - name: LP_ETL_NKOD_COUCHDB_USER
              valueFrom:
                secretKeyRef:
                  name: nkd-couchdb-secret
                  key: couchdb_user
            - name: LP_ETL_NKOD_COUCHDB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: nkd-couchdb-secret
                  key: couchdb_password
            # Solr
            - name: LP_ETL_NKOD_SOLR_URL
              value: http://nkd-solr:8983/solr
            # Adapter
            - name: LP_ETL_ADAPTER_PATH
              value: /data/adapter/
            # GraphQL
            - name: LP_ETL_NKOD_GRAPHQL_URL
              value: nkd-graphql
            - name: LP_ETL_NKOD_GRAPHQL_TOKEN
              valueFrom:
                secretKeyRef:
                  name: nkd-graphql-secret
                  key: graphql_reload_token
            - name: LP_ETL_NKOD_GRAPHQL_SSH_USER
              value: sshuser
            - name: LP_ETL_NKOD_GRAPHQL_SSH_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: nkd-graphql-secret
                  key: graphql_ssh_password
            # LDF - Linked Data Fragment
            - name: LP_ETL_NKOD_LDF_URL
              value: nkd-ldf
            - name: LP_ETL_NKOD_LDF_TOKEN
              valueFrom:
                secretKeyRef:
                  name: nkd-ldf-secret
                  key: ldf_reload_token
            - name: LP_ETL_NKOD_LDF_SSH_USER
              value: sshuser
            - name: LP_ETL_NKOD_LDF_SSH_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: nkd-ldf-secret
                  key: ldf_ssh_password
            # Path to the configuration.
            - name: LP_ETL_NKOD_CONFIGURATION
              value: /opt/nkd/lp-etl-configuration.ttl
          ports:
            - containerPort: 8085
          volumeMounts:
            - mountPath: "/data/lp-etl/"
              name: linkedpipes-etl-volume
            - mountPath: "/data/adapter/"
              name: adapter-volume
            - mountPath: "/data/public/"
              name: public-volume
            - mountPath: "/opt/nkd/"
              name: linkedpipes-etl-configuration
          securityContext:
            runAsUser: 5987
            runAsGroup: 5987
            runAsNonRoot: true
        - name: nkd-linkedpipes-etl-executor-monitor
          image: ghcr.io/linkedpipes/etl-executor-monitor:2023-04-03
          imagePullPolicy: Always
          env:
            - name: LP_ETL_DOMAIN
              value: "http://localhost:8080"
            - name: LP_ETL_EXECUTOR_URL
              value: "http://localhost:8085"
            - name: LP_ETL_EXECUTION_HISTORY_COUNT_LIMIT
              value: "3"
            - name: LP_ETL_EXECUTION_RETRY_LIMIT
              value: "3"
          ports:
            - containerPort: 8081
          volumeMounts:
            - mountPath: "/data/lp-etl/"
              name: linkedpipes-etl-volume
          securityContext:
            runAsUser: 5987
            runAsGroup: 5987
            runAsNonRoot: true
        - name: nkd-orchestrator
          image: ghcr.io/datagov-cz/nkd-orchestrator:develop
          imagePullPolicy: Always
          env:
            - name: FRONTEND_URL
              value: localhost:8080
            - name: STORAGE_URL
              value: localhost:8083
            - name: PIPELINE_URL
              value: https://oha02.dia.gov.cz/etl/resources/components/1700141340878-0004
            - name: STORAGE_REPOSITORY_BRANCH
              value: develop
            - name: STORAGE_REPOSITORY
              value: https://github.com/datagov-cz/nkd.git
          volumeMounts:
            - mountPath: "/data/lp-etl/"
              name: linkedpipes-etl-volume
            - mountPath: "/data/public/"
              name: public-volume
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: nkd-linkedpipes-etl-pvc
  namespace: nkd
  labels:
    app.kubernetes.io/name: linkedpipes-etl
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: managed-csi
  resources:
    requests:
      storage: 256Gi
---
apiVersion: v1
kind: Service
metadata:
  name: nkd-linkedpipes-etl
  namespace: nkd
  labels:
    app.kubernetes.io/name: linkedpipes-etl
spec:
  type: ClusterIP
  selector:
    app.kubernetes.io/name: linkedpipes-etl
  ports:
  - protocol: TCP
    targetPort: 8080
    port: 8080
